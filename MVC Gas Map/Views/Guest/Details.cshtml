
@{
    ViewBag.Title = "Details";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!------>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js" type="text/javascript"></script>
<!------>
<script src="~/Scripts/Control.FullScreen.js"></script>
<link href="~/Content/Control.FullScreen.css" rel="stylesheet" />
<!------>
<script src="~/Scripts/Control.MiniMap.js"></script>
<link href="~/Content/Control.MiniMap.css" rel="stylesheet" />
<!------>
<link href="~/Content/Control.Coordinates-0.1.5.css" rel="stylesheet" />
<script src="~/Scripts/Control.Coordinates-0.1.5.min.js"></script>
<!------>
<script src="~/Scripts/Control.IconLayer.Providers.js"></script>
<script src="~/Scripts/Control.IconLayers.js"></script>
<link href="~/Content/Control.IconLayers.css" rel="stylesheet" />
<!------>
<link href="~/Content/Control.MarkerHighLight.css" rel="stylesheet" />
<script src="~/Scripts/Control.MarkerHighLight.js"></script>
<!------>
<script src="~/Scripts/Control.MakiMarkers.js"></script>
<!------>
<!------>

<style>
    .leaflet-popup-content {
        margin: 15px 25px;
        line-height: 1.4;
    }

    .label {
        display: inline;
        padding: .2em .6em .3em;
        font-size: 75%;
        font-weight: 700;
        line-height: 1;
        color: #656;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: .25em;
    }

    .fullscreen-icon {
        background-image: url('../../Images/icon-fullscreen.png');
    }

    .leaflet-retina .fullscreen-icon {
        background-image: url('../../Images/icon-fullscreen-2x.png');
        background-size: 26px 26px;
    }

    .leaflet-container:-webkit-full-screen {
        width: 100% !important;
        height: 100% !important;
        z-index: 99999;
    }

    .leaflet-container:-ms-fullscreen {
        width: 100% !important;
        height: 100% !important;
        z-index: 99999;
    }

    .leaflet-container:full-screen {
        width: 100% !important;
        height: 100% !important;
        z-index: 99999;
    }

    .leaflet-container:fullscreen {
        width: 100% !important;
        height: 100% !important;
        z-index: 99999;
    }

    .leaflet-pseudo-fullscreen {
        position: fixed !important;
        width: 100% !important;
        height: 100% !important;
        top: 0px !important;
        left: 0px !important;
        z-index: 99999;
    }

    #idGasMap {
        width: 100%;
        height: 600px;
    }

    .map-popup-content {
        width: 260px;
    }

        .map-popup-content .left {
            float: left;
            width: 45%;
        }

            .map-popup-content .left img {
                width: 100%;
                height: 100px;
                margin: -15px 0 -15px -20px;
                border-radius: 12px;
            }

        .map-popup-content .right {
            float: left;
            width: 55%;
        }

    .clearfix {
        clear: both;
    }

    .toggle {
        background: orange !important;
    }

        .toggle:hover {
            background: darkorange !important;
        }


    .marker-pin {
        width: 30px;
        height: 30px;
        border-radius: 50% 50% 50% 0;
        background: #c30b82;
        position: absolute;
        transform: rotate(-45deg);
        left: 50%;
        top: 50%;
        margin: -15px 0 0 -15px;
    }

        .marker-pin::after {
            content: '';
            width: 24px;
            height: 24px;
            margin: 3px 0 0 3px;
            background: #fff;
            position: absolute;
            border-radius: 50%;
        }

    .custom-div-icon i {
        position: absolute;
        width: 22px;
        font-size: 22px;
        left: 0;
        right: 0;
        margin: 10px auto;
        text-align: center;
    }

        .custom-div-icon i.awesome {
            margin: 12px auto;
            font-size: 17px;
        }
</style>

<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800"><i class="glyphicon glyphicon-phone-alt" style="color:#ca4d1f;font-size:19px;"></i>
    <span style="font-weight: 500;font-size: initial;font-family: sans-serif;font-size:18px;">Dịch vụ gọi gas</span>
    </h1>
    <button onclick="goToCurrentLocation()" class="h3 mb-0 btn btn-default" style="background-color:#fdecec;"><i class="glyphicon glyphicon-tags mr-1 mt-1" style="color:#ca4d1f;font-size:19px;"></i>   <span style="font-weight: 500;font-size: initial;font-family: sans-serif;font-size:18px;">Vị trí của bạn</span></button>
</div>
<div class="@*container body-content*@" style="margin-top:0.1rem;">
    <div id="idGasMap"></div>
    <hr />
</div>


<script>
    // Variable
    var lat = null;
    var long = null;
    var popupContent = null;
    var defaultCoord = null;
    var mapObj = null;
    var marker;
    var zoomLevel = 15;
    var minimap = null;
    var flagMarkerCurLocation = false;
    //var amountOfStos = null;
    var url = new URL(document.URL);
    var search_params = url.searchParams;
    var markerGroup = null;
    var popup = L.popup();

    var osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    var osmAttrib = 'Có làm mới có ăn !!! ';
    var osm = new L.TileLayer(osmUrl, { minZoom: 5, maxZoom: 18, attribution: osmAttrib });
    var osm2 = new L.TileLayer(osmUrl, { minZoom: 0, maxZoom: 13, attribution: osmAttrib });
    ///////////////////
    //L.MakiMarkers.accessToken = 'pk.eyJ1IjoiZDNwemExMm81IiwiYSI6ImNrOWljamZqczE4M2EzcHFiY3NoZms2ZTYifQ.lhpwFvZyHvEy5fZFBBhXxw';


    //if (!search_params.has('lat') || !search_params.has('lng')) {
    //    defaultCoord = [21.061540, 105.781103];//toạ độ mặc địNH Ở PHẠM VĂN ĐỒNG
    //}
    //else {
    //    var latId = search_params.get('lat');
    //    var lngId = search_params.get('lng');
    //    defaultCoord = [latId, lngId];
    //}



    // Window load
    window.onload = function () {
        $("#introProject").show();
        if (typeof (Storage) !== "undefined") {
            var curLocation = localStorage.getItem("curLocation");
            if (curLocation != null) {
                flagMarkerCurLocation = true;
                var latAndLng = curLocation.split(",");
                defaultCoord = [Number(latAndLng[0]), Number(latAndLng[1])];
            }
        }
        else {
            console.log("pohip");
        }


        if (defaultCoord == null) {
            defaultCoord = [21.061540, 105.781103];//toạ độ mặc địNH Ở PHẠM VĂN ĐỒNG
        }
        var mapConfig = {
            attributionControl: true, // hiện watermark
            center: defaultCoord, // vị trí map mặc định hiện tại
            zoom: zoomLevel, // level zoom
            fullscreenControl: true,
            fullscreenControlOptions: {
                position: 'topleft'
            }
        };


        mapObj = new L.map('idGasMap', mapConfig);

        mapObj.addLayer(osm);


        //
        L.control.coordinates({
            position: "bottomleft",
            decimals: 0, //optional default 4
            decimalSeperator: ".", //optional default "."
            labelTemplateLat: "Latitude: {y}", //optional default "Lat: {y}"
            labelTemplateLng: "Longitude: {x}", //optional default "Lng: {x}"
            enableUserInput: true, //optional default true
            useDMS: false, //optional default false
            useLatLngOrder: true, //ordering of labels, default false-> lng-lat
            markerType: L.marker, //optional default L.marker
            markerProps: {} //optional default {}
        }).addTo(mapObj);

        mapObj.on('click', onMapClick);

        var layerGroup = new L.layerGroup([osm2]);
        minimap = new L.Control.MiniMap(layerGroup, { toggleDisplay: true }).addTo(mapObj);


        getAllStoresInDb();
        markerGroup = L.layerGroup().addTo(mapObj);
        //////////////
        if (this.flagMarkerCurLocation)
            setMarkerCurrentLocation(defaultCoord)
        ///////////////////


        ///
        var layers = [];
        for (var providerId in providers) {
            layers.push(providers[providerId]);
        }

        layers.push({
            layer: {
                onAdd: function () { },
                onRemove: function () { }
            },
            title: 'empty'
        })

        var ctrl = L.control.iconLayers(layers).addTo(mapObj);
        setInterval(function () {
            markerGroup.clearLayers();
            getAllStoresInDb();
        }, 500000)
    };
    ///////////////////

    function setMarkerCurrentLocation(defaultCoord) {
        const locationIcon = L.MakiMarkers.icon({
            // icon: "beer",
            icon: "star-stroked",
            color: "#13a",
            size: "xl"
        });

        marker = new L.marker(defaultCoord, { icon: locationIcon });

        marker.options.highlight = "permanent";
        mapObj.markers = marker;
        var popup = L.popup();
        popup.setContent("<span>Đây là vị trí của bạn </span>");

        // binding
        marker.bindPopup(popup);
        marker.addTo(markerGroup);
    }

    function addMarkerCircleInMiniMap(lat, long, layerGroup) {
        var myCircle = new L.CircleMarker(new L.LatLng(lat, long), { radius: 2 });
        layerGroup = layerGroup.addLayer(myCircle)
        return layerGroup;
    }

    function addMarker(coord, popupContent, popupOptionObj, markerObj) {
        if (!popupOptionObj) {
            popupOptionObj = {};
        }
        //var icon = L.divIcon({
        //    className: 'custom-div-icon',
        //    html: "<div style='background-color:#c30b82;' class='marker-pin'></div><i class='fa fa-camera awesome'></i>",
        //    iconSize: [30, 42],
        //    iconAnchor: [15, 42]
        //});
        const storeIcon = L.MakiMarkers.icon({
            //icon: "beer",
            icon: "building",
            color: "#12a",
            size: "l"
        });

        marker = new L.marker(coord, { icon: storeIcon });

        //console.log(marker);

        marker.options.highlight = "permanent";
        //marker.addTo(mapObj);
        mapObj.markers = marker;
        var popup = L.popup(popupOptionObj);
        popup.setContent(popupContent);

        // binding
        marker.bindPopup(popup);
        marker.addTo(markerGroup);


    }

    function onMapClick(e) {
        long = e.latlng.lng.toFixed(5);//lấy giá trị long
        lat = e.latlng.lat.toFixed(5);//lấy giá trị lat
        var html = `<h4>Toạ độ (` + lat + `,` + long + `)</h4>
        <button class="btn btn-primary" data-toggle="modal" data-target="#exampleModal" onclick="showPopUp()"><i class="glyphicon glyphicon-plus"></i> Tạo phòng </button>`;
        popup
            .setLatLng(e.latlng)
            .setContent(html)
            .openOn(mapObj);//hiện popup
        //console.log(e.latlng);
    }
    //
    function screenFull(map) {
        L.control.fullscreen({
            position: 'topleft', // change the position of the button can be topleft, topright, bottomright or bottomleft, defaut topleft
            title: 'Show me the fullscreen !', // change the title of the button, default Full Screen
            titleCancel: 'Exit fullscreen mode', // change the title of the button when fullscreen is on, default Exit Full Screen
            content: null, // change the content of the button, can be HTML, default null
            forceSeparateButton: true, // force seperate button to detach from zoom buttons, default false
            forcePseudoFullscreen: true, // force use of pseudo full screen even if full screen API is available, default false
            fullscreenElement: false // Dom element to render in full screen, false by default, fallback to map._container
        }).addTo(map);
    }


    function getAllStoresInDb() {
        var popupContent = null;
        var popupOption = {
            className: "map-popup-content",
        };


        $.ajax({
            type: 'get',
            url: '/Store/getAllStores',
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            beforeSend: function () {
                $(".loader").show();
            },
            success: function (data) {
                if (1 == 1) {
                    var name = null;
                    var layerGroup = new L.layerGroup([osm2]);
                    var responsive = data.data;
                    //console.log(responsive.length);
                    for (let i = 0; i < responsive.length; i++) {
                        if (responsive[i].StoreName == null) {
                            name = `Cửa hàng gas`;
                        } else {
                            name = responsive[i].StoreName;
                        }

                        popupContent = `<div class='left'><img src="/Images/buy-vector-flat-4.png" width="100%" /></div>`;
                        popupContent += `<div class='right'><h5>${name}</h5><br>`;
                        popupContent += `<button class="btn btn-primary" data-toggle="modal" data-target="#exampleModal1" onclick="showPopUpDetailStore('${responsive[i].StoreID}')">
                        <i class="glyphicon glyphicon-eye-open"></i>
                        Xem chi tiết
                        </button></div>`;
                        popupContent += `<div class='clearfix'></div>`;

                        addMarker([Number(responsive[i].Latitude), Number(responsive[i].Longitude)], popupContent, popupOption);
                        layerGroup = addMarkerCircleInMiniMap(Number(responsive[i].Latitude), Number(responsive[i].Longitude), layerGroup);
                    }
                    //var miniMap = new L.Control.MiniMap(layerGroup, { toggleDisplay: true }).addTo(mapObj);
                    minimap.changeLayer(layerGroup);

                }
            }
        })
        $(".loader").hide();
    }


    function showPopUp() {
        var str = `Tạo phòng ở toạ độ (${lat},${long})`;
        $('#exampleModalLabel').text(str);
    }

    function addRoom() {
        var url = `/Points/Main?lat=${lat}&lng=${long}`;

        var mapName = $('#mapName').val();//HẢI BÉO
        var phoneNumber = $('#phoneNumber').val();
        var address = $('#address').val();
        var moneyEachMonth = $('#moneyEachMonth').val();
        var acreageRoom = $('#acreageRoom').val();
        var descriptionDetail = $('#descriptionDetail').val();

        var parameters = `{ MapName: '${mapName}',
                            Latitude:'${lat}',
                            Longitude:'${long}',
                            PhoneNumber:'${phoneNumber}',
                            Address:'${address}',
                            MoneyEachMonth:'${moneyEachMonth}',
                            AcreageRoom:'${acreageRoom}',
                            DescriptionDetail:'${descriptionDetail}'
                            }`;//tạo string


        $.ajax({
            type: 'POST',
            url: '/Points/Save',
            dataType: 'JSON',
            contentType: 'application/json; charset=utf-8',
            data: parameters,
            success: function (data) {
                if (1 == 1) {
                    alert("Tạo phòng trọ thành công");
                    $(location).attr('href', url);//chuyển url
                }
            }

        })
    }

    function showPopUpDetailStore(storeId) {

        $.ajax({
            type: 'POST',
            url: '/Store/getDetailStore?storeId=' + storeId,
            dataType: 'JSON',
            success: function (data) {
                if (1 === 1) {
                    var responsive = data.data;
                    if (responsive.length == 1) {
                        //alert('Success')
                        //$('#mapName1').val(data[0].mapName);
                        //$('#phoneNumber1').val(data[0].phoneNumber);
                        //$('#address1').val(data[0].address);
                        //$('#moneyEachMonth1').val(data[0].moneyEachMonth);
                        //$('#acreageRoom1').val(data[0].acreageRoom);
                        //$('#descriptionDetail1').val(data[0].descriptionDetail);
                    }
                }

            }
        })

        var str = `Chi tiết `;
        $('#exampleModalLabel1').text(str);
    }


</script>

<script>

    function goToCurrentLocation()
    {
        navigator.geolocation.getCurrentPosition
            (
            function (location)
            {
                var currentLocation = new L.LatLng(location.coords.latitude, location.coords.longitude);
                mapObj.setView(currentLocation, zoomLevel);
                var curLocation = [location.coords.latitude, location.coords.longitude];
                markerGroup.clearLayers();
                setMarkerCurrentLocation(curLocation);
                getAllStoresInDb();
                localStorage.removeItem("curLocation");
                localStorage.setItem("curLocation", curLocation);
            });

    }
</script>
