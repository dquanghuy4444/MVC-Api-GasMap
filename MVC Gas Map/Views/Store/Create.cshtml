@{
    ViewBag.Title = "Create";
    string CurrentURL = Request.Url.AbsoluteUri;
    if (CurrentURL.Contains("Create"))
    {
        Layout = "~/Views/Shared/_Layout.cshtml";
    }

}
<link href="~/Scripts/Leaflet/LeafLet/leaflet.css" rel="stylesheet" />
<script src="~/Scripts/Leaflet/LeafLet/leaflet.js"></script>
<!------>
<link href="~/Content/Leaflet/Control.Coordinates-0.1.5.css" rel="stylesheet" />
<script src="~/Scripts/Leaflet/Control.Coordinates-0.1.5.min.js"></script>
<!------>
<link href="~/Content/Leaflet/Control.MarkerHighLight.css" rel="stylesheet" />
<script src="~/Scripts/Leaflet/Control.MarkerHighLight.js"></script>
<!------>
<script src="~/Scripts/Leaflet/Control.MakiMarkers.js"></script>
<!------>
<script src="~/Scripts/Leaflet/Search Control/esri-leaflet.js"></script>
<link href="~/Scripts/Leaflet/Search Control/src/esri-leaflet-geocoder.css" rel="stylesheet" />
<script src="~/Scripts/Leaflet/Search Control/src/esri-leaflet-geocoder.js"></script>
<!------>
<script src="~/Scripts/Leaflet/Common/Common.js"></script>

<style>
    #idMap {
        width: 100%;
        height: 30rem;
    }
</style>

<div class="container mt-3" style="padding: 0px 4rem;">
    <div class="card o-hidden border-0 shadow-lg my-5">
        <h1 class="text-center mt-2">Thông tin cửa hàng</h1>
        <div style="padding:4rem 6rem 6rem">
            <div class="col-md-9 col-xs-9 col-lg-9 col-sm-12">
                <div class="form-group">
                    <label for="exampleFormControlInput1">Tên cửa hàng</label>
                    <input type="text" name="fullname" class="form-control" id="StoreName" placeholder="Cửa hàng gas" required>
                </div>
                <div class="form-group">
                    <label for="exampleFormControlInput2">Số điện thoại</label>
                    <input type="text" name="phone" class="form-control" id="StorePhone" placeholder="1900" required>
                </div>
                <div class="form-group">
                    <label for="exampleFormControlInput3">Email</label>
                    <input type="email" name="email" class="form-control" id="StoreEmail" placeholder="" abc@gmail.com" required>
                </div>
                <div class="form-group">
                    <label for="exampleFormControlInput4">Địa chỉ</label>
                    <input type="text" name="address" class="form-control" id="StoreAddress" placeholder="" abc,def" required>
                </div>

                <label for="exampleFormControlInput4">Gim toạ độ cửa hàng</label>
                <div class="form-group" style="border: 1.3px solid #c3c3d7;border-radius: 0.4rem;">
                    <div class="mt-2 ml-2 mb-2 mr-2">
                        <div class="d-sm-flex align-items-center justify-content-between mb-4">
                            @*<div class="input-group" style="width:40%">
                                    <input type="text" class="form-control bg-light border-0 small" id="search_input" placeholder="Search for..." aria-label="Search" aria-describedby="basic-addon2">
                                    <input type="hidden" id="latitude_input" />
                                    <input type="hidden" id="longitude_input" />

                                    <div class="input-group-append">
                                        <button class="btn btn-primary" onclick="findByAddress()" type="button">
                                            <i class="fa fa-search fa-sm"></i>
                                        </button>
                                    </div>
                                </div>*@
                            <button onclick="goToCurrentLocation()" class="h3 mt-1 btn btn-default" style="background-color:#fdecec;"><i class="glyphicon glyphicon-tags mr-1 mt-1" style="color:#ca4d1f;font-size:1rem;"></i>   <span style="font-weight: 500;font-size: initial;font-family: sans-serif;font-size:1rem;">Vị trí của bạn</span></button>
                        </div>

                        <div id="idMap" class="mt-2"></div>
                        <div class="mt-2" id="latAndLongArea" style="font-size:1.2rem;font-weight:400;display:none;">
                            <span>Latitude:</span>
                            <span class="text-nowrap bd-highlight text-info" id="latitude_view"></span>
                            <span class="ml-2">Longitude:</span>
                            <span class="text-nowrap bd-highlight text-info" id="longitude_view"></span>
                            <br />
                            @*<span>Địa chỉ:</span>
                                <span class="text-nowrap bd-highlight text-info" id="addressOfGGMap">Số 401 Cổ Nhuế</span>
                                <button class="btn btn-primary" id="btn_GetAddressOfGGMap"><i class="glyphicon glyphicon-plus"></i> Lấy địa chỉ này </button>*@
                        </div>

                    </div>

                </div>
                <div class="form-group">
                    <label for="exampleFormControlInput5">Giới thiệu về cửa hàng</label>
                    <textarea class="form-control" rows="6" id="StoreDetail"></textarea>
                </div>
            </div>
            <div class="col-md-3 col-xs-3 col-lg-3 col-sm-12">
                <div class="form-group" style="margin-top: 2rem;">
                    <div style="height: 30rem;width: 100%;position: absolute;border: 2px solid #cd8e8e;">
                        <img src="~/Images/pngtree-shop-store-market-building-shopping-flat-color-icon-vector-png-image_1653492.jpg" id="StoreImg" style="position: relative;width: 100%;height: 100%;padding: 0.4rem;" />
                    </div>
                </div>
                <div class="form-group" style="margin-top: 33rem;">
                    <input type="file" accept="image/*" id="myFile" multiple size="50" onchange="changeStoreImage(event)">
                </div>
            </div>
            <div class="col-xs-12 col-sm-12 col-lg-12 col-md-12">
                <button type="button" class="btn btn-success" id="btn_CreateOrEditStore" onclick="createStore()">Tạo cửa hàng</button>
                <a href="/Home/Index" id="btn_Close" class="btn btn-danger">Thoát</a>
            </div>
        </div>
    </div>
</div>

<!---------------CHECK VALID INPUT TO CREATE STORE---------------->
<script type="text/javascript">
    var flagGetLatLn = false;
    function checkValid() {
        var strLength = "Tối đa 36 kí tự"
        var strFormatPhone = "Định dạng điện thoại sai";

        var name = document.getElementById("StoreName").value;
        var phone = document.getElementById("StorePhone").value;
        var email = document.getElementById("StoreEmail").value;
        var addr = document.getElementById("StoreAddress").value;
        var detail = document.getElementById("StoreDetail").value;

        var vnf_regex = /((09|03|07|08|05)+([0-9]{8})\b)/g;
        var reg = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;

        if (!name) {
            message_Error("StoreName", STR_WARNING_EMPTY);
            return false;
        }
        else if (name.length > 36) {
            message_Error("StoreName", strLength);
            return false;
        }

        if (!phone) {
            message_Error("StorePhone", STR_WARNING_EMPTY);
            return false;
        }
        else {
            if (vnf_regex.test(phone) == false) {
                message_Error("StorePhone", strFormatPhone);
                return false;
            }
        }

        if (!email) {
            message_Error("StoreEmail", STR_WARNING_EMPTY);
            return false;
        }
        else {
            if (reg.test(email) == false) {
                message_Error("StoreEmail", STR_WARNING_EMPTY);
                return false;
            }
        }

        if (!addr) {
            message_Error("StoreAddress", STR_WARNING_EMPTY);
            return false;
        }

        if (!detail) {
            message_Error("StoreDetail", STR_WARNING_EMPTY);
            return false;
        }

        return true;
    }

</script>

<!---------------CALL AJAX TO CREATE STORE FROM STORE CONTROLLER---------------->
<script>
    function createStore() {
        if (checkValid()) {
            if (flagGetLatLn) {
                var userIDBySes = sessionStorage.getItem("UserID");

                var storeName = $('#StoreName').val();
                var storePhone = $('#StorePhone').val();
                var storeEmail = $('#StoreEmail').val();
                var storeAddress = $('#StoreAddress').val();
                var storeDetail = $('#StoreDetail').val();
                var imgSrc = $('#StoreImg').attr('src');
                var lat = $('#latitude_view').html();
                var long = $('#longitude_view').html();

                var store = {
                    StoreName: storeName,
                    StorePhone: storePhone,
                    StoreEmail: storeEmail,
                    StoreAddress: storeAddress,
                    StoreDetail: storeDetail,
                    ImgSrc: imgSrc,
                    UserID: userIDBySes,
                    Latitude: lat,
                    Longitude: long
                }
                console.log(store);

                $.ajax({
                    type: 'Get',
                    contentType: 'application/json; charset=utf-8',
                    url: '/Store/CreateStore',
                    dataType: 'Json',
                    data: store,
                    success: function (data) {
                        console.log(data);

                        var status = data.status;
                        var message = data.message;
                        var permissID = data.permissionID;

                        switch (status) {
                            case INT_FLAGCHECK_FAIL:
                                message_Error("", message);
                                break;
                            case INT_FLAGCHECK_SUCCESS:
                                localStorage.setItem("successMess", JSON.stringify(message));
                                clearInterval(interval);
                                sessionStorage.setItem("PermissionID", permissID);
                                setTimeout(function () { window.location.href = "/Store/Details"; }, 1800);

                                break;
                        }
                    },
                    error: function (data) {
                        message_Error("", "Tạo mới cửa hàng thất bại")
                    },
                });
            }
            else
                message_Error("", "Bạn chưa lấy tọa độ cửa hàng .");
        }
    }
</script>

<!---------------GLOBAL VARIABLES---------------->
<script>
    // Variable
    var lat = null;
    var long = null;
    var popupContent = null;
    var defaultCoord = null;
    var mapObj = null;
    var marker;
    var minimap = null;
    var flagMarkerCurLocation = false;
    //var amountOfStos = null;
    var url = new URL(document.URL);
    var search_params = url.searchParams;
    var markerGroup = null;
    var popup = L.popup();

    var osm = new L.TileLayer(STR_OSM_URL, { minZoom: 5, maxZoom: 18, attribution: STR_OSM_ATTRIBUTE });
    var osm2 = new L.TileLayer(STR_OSM_URL, { minZoom: 0, maxZoom: 13, attribution: STR_OSM_ATTRIBUTE });

</script>

<!---------------WINDOWN ON LOAD---------------->
<script>
    window.onload = function () {
        if (defaultCoord == null) {
            defaultCoord = ARR_DEFAULT_COORD
        }
        var mapConfig = {
            attributionControl: true, // hiện watermark
            center: defaultCoord,
            zoom: INT_ZOOM_MAP_LEVEL,
            fullscreenControl: true,
            fullscreenControlOptions: {
                position: 'topleft'
            }
        };

        mapObj = new L.map('idMap', mapConfig);

        mapObj.addLayer(osm);

        markerGroup = L.layerGroup().addTo(mapObj);

        /////////////////
        addCoordBox(mapObj);

        mapObj.on('click', onMapClick);

        var layerGroup = new L.layerGroup([osm2]);

        //////////////
        setMarkerCurrentLocation(defaultCoord)
        ///////////////////
        addSearchControl(mapObj);
    };
</script>

<!---------------EVENT FOR OPEN STREET MAP--------------------->
<script>
    function onMapClick(e) {
        long = e.latlng.lng.toFixed(5);//lấy giá trị long
        lat = e.latlng.lat.toFixed(5);//lấy giá trị lat
        var html = `<h4>Toạ độ (` + lat + `,` + long + `)</h4>
                        <button class="btn btn-primary" onclick="getLatAndLong()"><i class="glyphicon glyphicon-plus"></i> Lấy toạ độ này </button>`;
        popup
            .setLatLng(e.latlng)
            .setContent(html)
            .openOn(mapObj);//hiện popup
    }

    function goToCurrentLocation() {
        navigator.geolocation.getCurrentPosition
            (
                function (location) {
                    var currentLocation = new L.LatLng(location.coords.latitude, location.coords.longitude);
                    mapObj.setView(currentLocation, INT_ZOOM_MAP_LEVEL);
                    var curLocation = [location.coords.latitude, location.coords.longitude];
                    setMarkerCurrentLocation(curLocation);
                    localStorage.removeItem("curLocation");
                    localStorage.setItem("curLocation", curLocation);
                });

    }

    function setMarkerCurrentLocation(defaultCoord) {
        const locationIcon = L.MakiMarkers.icon({
            // icon: "beer",
            icon: "star-stroked",
            color: "#13a",
            size: "xl"
        });

        marker = new L.marker(defaultCoord, { icon: locationIcon });

        lat = defaultCoord[0];
        long = defaultCoord[1];
        marker.options.highlight = "permanent";
        mapObj.markers = marker;
        var popup = L.popup();

        var strHtml = "<span>Đây là vị trí của bạn </span>";
        strHtml += `<br><button class="btn btn-primary text-center" data-toggle="modal" data-target="#exampleModal" onclick="getLatAndLong()"><i class="glyphicon glyphicon-plus"></i> Lấy toạ độ này </button>`;

        popup.setContent(strHtml);

        // binding
        marker.bindPopup(popup);
        marker.addTo(markerGroup);
        markerGroup = L.layerGroup().addTo(mapObj);
    }

    function getLatAndLong() {
        flagGetLatLn = true;
        $('#latAndLongArea').show()
        $('#latitude_view').html(lat);
        $('#longitude_view').html(long);
    }
</script>

<!---------------EVENT CHANGE SOURCE STORE IMAGE--------------------->
<script>
    function changeStoreImage(event) {
        var getImagePath = URL.createObjectURL(event.target.files[0]);
        $("#StoreImg").attr("src", getImagePath);
    }
</script>

<script>

    function getJsonData(url, callback) {
        let request = new XMLHttpRequest;
        let timer = setTimeout(function () {
            getJsonData(url, callback);
        }, 10000);
        request.onreadystatechange = function () {
            if (request.readyState === 4 && request.status === 200) {
                clearTimeout(timer);
                return callback(JSON.parse(request.responseText));
            }
        }
        request.open('GET', url);
        request.send();
    }
</script>




